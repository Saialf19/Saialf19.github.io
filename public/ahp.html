<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Configuración AHP con Subcriterios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .ahp-step { font-size: 0.9rem; background: #f8f9fa; padding: 10px; border: 1px solid #ccc; margin-top: 10px; }
    table td input { min-width: 50px; text-align: center; }
  </style>
</head>
<body class="p-5">
  <h2 class="mb-4">Configura tu análisis AHP con Subcriterios</h2>
  <!-- Formulario para ingresar número de criterios y alternativas -->
  <form id="config-form">
    <div class="row mb-3">
      <div class="col">
        <label>Número de criterios</label>
        <input type="number" class="form-control" id="numCriterios" min="1" required>
      </div>
      <div class="col">
        <label>Número de alternativas</label>
        <input type="number" class="form-control" id="numAlternativas" min="1" required>
      </div>
    </div>
    <button type="submit" class="btn btn-primary">Generar formulario</button>
  </form>

  <!-- Formulario para ingresar nombres de criterios y alternativas -->
  <form id="datos-form" class="mt-4 d-none"></form>

  <!-- Contenedor para matrices y resultados -->
  <div id="matriz-container" class="mt-5 d-none">
    <h4>Matriz de comparación de criterios</h4>
    <form id="matriz-form"></form>
    <div id="explicacion-criterios" class="ahp-step"></div>
    <div id="matrices-subcriterios"></div>
    <div id="matrices-alternativas"></div>
    <button id="calcular-btn" class="btn btn-info mt-3">Calcular Pesos</button>
    <button id="limpiar-btn" class="btn btn-secondary mt-3 ms-2">Limpiar Todo</button>
    <div id="resultados" class="mt-4"></div>
    <div id="excel-descarga" class="mt-3"></div>
  </div>

<script>
const allowedValues = [
  1/9, 1/8, 1/7, 1/6, 1/5, 1/4, 1/3, 1/2,
  1, 2, 3, 4, 5, 6, 7, 8, 9
];

const configForm = document.getElementById('config-form');
const datosForm = document.getElementById('datos-form');
const matrizContainer = document.getElementById('matriz-container');
const matrizForm = document.getElementById('matriz-form');
const matricesSubcriterios = document.getElementById('matrices-subcriterios');
const matricesAlternativas = document.getElementById('matrices-alternativas');
const calcularBtn = document.getElementById('calcular-btn');
const limpiarBtn = document.getElementById('limpiar-btn');
const resultadosDiv = document.getElementById('resultados');
const explicacionCriterios = document.getElementById('explicacion-criterios');
const excelDescarga = document.getElementById('excel-descarga');

let criterios = [];
let alternativas = [];
let subcriteriosPorCriterio = {};
let numSubcriteriosPorCriterio = {};

configForm.addEventListener('submit', function (e) {
  e.preventDefault();
  const numC = parseInt(document.getElementById('numCriterios').value);
  const numA = parseInt(document.getElementById('numAlternativas').value);

  let html = '<h4>Ingrese los nombres de criterios y alternativas</h4>';
  html += '<div id="criterios-container"></div>';
  html += '<div id="alternativas-container" class="mt-3"></div>';
  html += '<button type="submit" class="btn btn-success mt-3">Continuar</button>';
  datosForm.innerHTML = html;
  datosForm.classList.remove('d-none');

  // Inputs criterios
  const criteriosContainer = datosForm.querySelector('#criterios-container');
  for (let i = 0; i < numC; i++) {
    const input = document.createElement('input');
    input.name = `criterio${i}`;
    input.placeholder = `Criterio ${i + 1}`;
    input.className = 'form-control mb-2';
    criteriosContainer.appendChild(input);
  }
  // Inputs alternativas
  const alternativasContainer = datosForm.querySelector('#alternativas-container');
  for (let i = 0; i < numA; i++) {
    const input = document.createElement('input');
    input.name = `alternativa${i}`;
    input.placeholder = `Alternativa ${i + 1}`;
    input.className = 'form-control mb-2';
    alternativasContainer.appendChild(input);
  }
});

// Paso 2: Ingreso de subcriterios
datosForm.addEventListener('submit', function (e) {
  e.preventDefault();
  const formData = new FormData(datosForm);
  criterios = Object.keys(Object.fromEntries(formData.entries())).filter(k => k.startsWith('criterio')).map(k => formData.get(k));
  alternativas = Object.keys(Object.fromEntries(formData.entries())).filter(k => k.startsWith('alternativa')).map(k => formData.get(k));

  // Pide número de subcriterios por criterio
  let subFormHtml = '<h4>Subcriterios por criterio</h4>';
  criterios.forEach((crit, idx) => {
    subFormHtml += `
      <div class="mb-2">
        <label>¿Cuántos subcriterios para <b>${crit}</b>?</label>
        <input type="number" min="1" max="10" class="form-control" id="numSub_${idx}" value="1" required>
      </div>
    `;
  });
  subFormHtml += `<button type="button" class="btn btn-primary mt-3" id="continuarSubBtn">Continuar con subcriterios</button>`;
  datosForm.innerHTML = subFormHtml;

  document.getElementById('continuarSubBtn').onclick = function () {
    criterios.forEach((crit, idx) => {
      numSubcriteriosPorCriterio[crit] = parseInt(document.getElementById(`numSub_${idx}`).value);
    });

    // Pide nombres de subcriterios
    let subNamesHtml = '<h4>Nombres de subcriterios</h4>';
    criterios.forEach((crit, idx) => {
      subNamesHtml += `<div class="mb-2"><b>${crit}</b><br>`;
      for (let s = 0; s < numSubcriteriosPorCriterio[crit]; s++) {
        subNamesHtml += `<input type="text" class="form-control mb-1" id="subcrit_${idx}_${s}" placeholder="Subcriterio ${s + 1}" required>`;
      }
      subNamesHtml += '</div>';
    });
    subNamesHtml += `<button type="button" class="btn btn-success mt-3" id="continuarMatricesBtn">Continuar</button>`;
    datosForm.innerHTML = subNamesHtml;

    document.getElementById('continuarMatricesBtn').onclick = function () {
      subcriteriosPorCriterio = {};
      criterios.forEach((crit, idx) => {
        subcriteriosPorCriterio[crit] = [];
        for (let s = 0; s < numSubcriteriosPorCriterio[crit]; s++) {
          subcriteriosPorCriterio[crit].push(document.getElementById(`subcrit_${idx}_${s}`).value);
        }
      });

      // Genera matrices
      generarMatrizComparacion();
      generarMatricesSubcriterios();
      generarMatricesAlternativasSub();
      matrizContainer.classList.remove('d-none');
    };
  };
});

// --- MATRIZ DE CRITERIOS ---
function generarMatrizComparacion() {
  matrizForm.innerHTML = '';
  const table = document.createElement('table');
  table.className = 'table table-bordered';

  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th></th>' + criterios.map(c => `<th>${c}</th>`).join('');
  thead.appendChild(headRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  for (let i = 0; i < criterios.length; i++) {
    const row = document.createElement('tr');
    row.innerHTML = `<th>${criterios[i]}</th>`;
    for (let j = 0; j < criterios.length; j++) {
      const td = document.createElement('td');
      if (i === j) {
        td.innerHTML = '<input class="form-control" value="1" disabled />';
      } else if (i < j) {
        const select = document.createElement('select');
        select.name = `comp_${i}_${j}`;
        select.className = 'form-select';
        allowedValues.forEach(val => {
          const option = document.createElement('option');
          option.value = val;
          option.text = val === 1 ? '1 (Igual)' : val < 1 ? `1/${Math.round(1/val)}` : val;
          select.appendChild(option);
        });
        select.value = 1;
        select.addEventListener('change', function () {
          const recVal = 1 / parseFloat(this.value);
          const oppSelect = document.querySelector(`[name=comp_${j}_${i}]`);
          if (oppSelect) {
            oppSelect.value = recVal;
          }
        });
        td.appendChild(select);
      } else {
        const select = document.createElement('select');
        select.name = `comp_${i}_${j}`;
        select.className = 'form-select';
        allowedValues.forEach(val => {
          const option = document.createElement('option');
          option.value = val;
          option.text = val === 1 ? '1 (Igual)' : val < 1 ? `1/${Math.round(1/val)}` : val;
          select.appendChild(option);
        });
        select.value = 1;
        td.appendChild(select);
      }
      row.appendChild(td);
    }
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  matrizForm.appendChild(table);
}

// --- MATRICES DE SUBCRITERIOS ---
function generarMatricesSubcriterios() {
  matricesSubcriterios.innerHTML = '';
  criterios.forEach((crit, idx) => {
    const subs = subcriteriosPorCriterio[crit];
    let html = `<div class="mt-4"><h5>Matriz de comparación de subcriterios para: ${crit}</h5>`;
    html += `<table class="table table-bordered"><thead><tr><th></th>${subs.map(s => `<th>${s}</th>`).join('')}</tr></thead><tbody>`;
    for (let i = 0; i < subs.length; i++) {
      html += `<tr><th>${subs[i]}</th>`;
      for (let j = 0; j < subs.length; j++) {
        if (i === j) {
          html += `<td><input class="form-control" value="1" disabled /></td>`;
        } else if (i < j) {
          html += `<td><select class="form-select" name="subcomp_${idx}_${i}_${j}">${allowedValues.map(val =>
            `<option value="${val}">${val === 1 ? '1 (Igual)' : val < 1 ? `1/${Math.round(1/val)}` : val}</option>`
          ).join('')}</select></td>`;
        } else {
          html += `<td><select class="form-select" name="subcomp_${idx}_${i}_${j}">${allowedValues.map(val =>
            `<option value="${val}">${val === 1 ? '1 (Igual)' : val < 1 ? `1/${Math.round(1/val)}` : val}</option>`
          ).join('')}</select></td>`;
        }
      }
      html += `</tr>`;
    }
    html += `</tbody></table><div class='ahp-step' id='explicacion_sub_${idx}'></div></div>`;
    matricesSubcriterios.innerHTML += html;
  });
}

// --- MATRICES DE ALTERNATIVAS POR SUBCRITERIO ---
function generarMatricesAlternativasSub() {
  matricesAlternativas.innerHTML = '';
  criterios.forEach((crit, cidx) => {
    const subs = subcriteriosPorCriterio[crit];
    subs.forEach((sub, sidx) => {
      const div = document.createElement('div');
      div.className = 'mt-4';
      div.innerHTML = `<h5>Comparación de alternativas para: <b>${sub}</b> (${crit})</h5>`;
      const table = document.createElement('table');
      table.className = 'table table-bordered';

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      headRow.innerHTML = '<th></th>' + alternativas.map(a => `<th>${a}</th>`).join('');
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      for (let i = 0; i < alternativas.length; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `<th>${alternativas[i]}</th>`;
        for (let j = 0; j < alternativas.length; j++) {
          const td = document.createElement('td');
          if (i === j) {
            td.innerHTML = '<input class="form-control" value="1" disabled />';
          } else if (i < j) {
            const select = document.createElement('select');
            select.name = `altsub_${cidx}_${sidx}_${i}_${j}`;
            select.className = 'form-select';
            allowedValues.forEach(val => {
              const option = document.createElement('option');
              option.value = val;
              option.text = val === 1 ? '1 (Igual)' : val < 1 ? `1/${Math.round(1/val)}` : val;
              select.appendChild(option);
            });
            select.value = 1;
            select.addEventListener('change', function () {
              const recVal = 1 / parseFloat(this.value);
              const oppSelect = document.querySelector(`[name=altsub_${cidx}_${sidx}_${j}_${i}]`);
              if (oppSelect) {
                oppSelect.value = recVal;
              }
            });
            td.appendChild(select);
          } else {
            const select = document.createElement('select');
            select.name = `altsub_${cidx}_${sidx}_${i}_${j}`;
            select.className = 'form-select';
            allowedValues.forEach(val => {
              const option = document.createElement('option');
              option.value = val;
              option.text = val === 1 ? '1 (Igual)' : val < 1 ? `1/${Math.round(1/val)}` : val;
              select.appendChild(option);
            });
            select.value = 1;
            td.appendChild(select);
          }
          row.appendChild(td);
        }
        tbody.appendChild(row);
      }
      table.appendChild(tbody);
      div.appendChild(table);
      div.innerHTML += `<div class='ahp-step' id='explicacion_altsub_${cidx}_${sidx}'></div>`;
      matricesAlternativas.appendChild(div);
    });
  });
}

// --- CÁLCULO PRINCIPAL ---
calcularBtn.addEventListener('click', function () {
  // --- Criterios ---
  const matrix = [];
  for (let i = 0; i < criterios.length; i++) {
    matrix[i] = [];
    for (let j = 0; j < criterios.length; j++) {
      const sel = document.querySelector(`[name=comp_${i}_${j}]`);
      matrix[i][j] = sel ? Number(sel.value) : 1;
    }
  }
  // Suma columnas
  const colSums = Array(criterios.length).fill(0);
  for (let j = 0; j < criterios.length; j++)
    for (let i = 0; i < criterios.length; i++) colSums[j] += Number(matrix[i][j]);
  // Normaliza
  const normMatrix = matrix.map(row => row.map((val, j) => Number(val) / colSums[j]));
  // Pesos criterios
  const pesosCriterios = normMatrix.map(row => row.reduce((a, b) => a + b, 0) / criterios.length);

  // --- Subcriterios ---
  let pesosSubcriteriosPorCriterio = {}; // {criterio: [pesos subcriterios]}
  criterios.forEach((crit, cidx) => {
    const subs = subcriteriosPorCriterio[crit];
    const n = subs.length;
    const subMatrix = [];
    for (let i = 0; i < n; i++) {
      subMatrix[i] = [];
      for (let j = 0; j < n; j++) {
        const sel = document.querySelector(`[name=subcomp_${cidx}_${i}_${j}]`);
        subMatrix[i][j] = sel ? Number(sel.value) : 1;
      }
    }
    // Suma columnas
    const colSum = Array(n).fill(0);
    for (let j = 0; j < n; j++)
      for (let i = 0; i < n; i++) colSum[j] += subMatrix[i][j];
    // Normaliza
    const norm = subMatrix.map(row => row.map((val, j) => val / colSum[j]));
    // Pesos
    const pesos = norm.map(row => row.reduce((a, b) => a + b, 0) / n);
    pesosSubcriteriosPorCriterio[crit] = pesos;
    // Explicación
    const paso = `<strong>Suma columnas:</strong> [${colSum.map(x => x.toFixed(3)).join(', ')}]<br>` +
      `<strong>Matriz normalizada:</strong><br>` +
      norm.map(row => row.map(v => v.toFixed(3)).join(' | ')).join('<br>') + '<br>' +
      `<strong>Pesos:</strong> [${pesos.map(p => p.toFixed(4)).join(', ')}]`;
    const expl = document.getElementById(`explicacion_sub_${cidx}`);
    if (expl) expl.innerHTML = paso;
  });

  // --- Alternativas respecto a cada subcriterio ---
  let pesosAlternativasPorSubcriterio = {}; // {cidx_sidx: [pesos alternativas]}
  criterios.forEach((crit, cidx) => {
    const subs = subcriteriosPorCriterio[crit];
    subs.forEach((sub, sidx) => {
      const n = alternativas.length;
      const altMatrix = [];
      for (let i = 0; i < n; i++) {
        altMatrix[i] = [];
        for (let j = 0; j < n; j++) {
          const sel = document.querySelector(`[name=altsub_${cidx}_${sidx}_${i}_${j}]`);
          altMatrix[i][j] = sel ? Number(sel.value) : 1;
        }
      }
      // Suma columnas
      const colSum = Array(n).fill(0);
      for (let j = 0; j < n; j++)
        for (let i = 0; i < n; i++) colSum[j] += altMatrix[i][j];
      // Normaliza
      const norm = altMatrix.map(row => row.map((val, j) => val / colSum[j]));
      // Pesos
      const pesos = norm.map(row => row.reduce((a, b) => a + b, 0) / n);
      pesosAlternativasPorSubcriterio[`${cidx}_${sidx}`] = pesos;
      // Explicación
      const paso = `<strong>Suma columnas:</strong> [${colSum.map(x => x.toFixed(3)).join(', ')}]<br>` +
        `<strong>Matriz normalizada:</strong><br>` +
        norm.map(row => row.map(v => v.toFixed(3)).join(' | ')).join('<br>') + '<br>' +
        `<strong>Pesos:</strong> [${pesos.map(p => p.toFixed(4)).join(', ')}]`;
      const expl = document.getElementById(`explicacion_altsub_${cidx}_${sidx}`);
      if (expl) expl.innerHTML = paso;
    });
  });

  // --- Puntaje global de cada alternativa ---
  // Puntaje = suma sobre criterios [peso criterio × suma sobre subcriterios (peso subcriterio × peso alternativa respecto a subcriterio)]
  const puntajesFinales = alternativas.map((_, aidx) => {
    let total = 0;
    criterios.forEach((crit, cidx) => {
      const pesoCrit = pesosCriterios[cidx];
      const subs = subcriteriosPorCriterio[crit];
      let subtotal = 0;
      subs.forEach((sub, sidx) => {
        const pesoSub = pesosSubcriteriosPorCriterio[crit][sidx];
        const pesoAlt = pesosAlternativasPorSubcriterio[`${cidx}_${sidx}`][aidx];
        subtotal += pesoSub * pesoAlt;
      });
      total += pesoCrit * subtotal;
    });
    return total;
  });

  // --- Mostrar resultados finales ---
  let finalTexto = `<h5>Resultado Final:</h5><ul>`;
  alternativas.forEach((alt, i) => {
    finalTexto += `<li><strong>${alt}</strong>: <strong>${puntajesFinales[i].toFixed(4)}</strong></li>`;
  });
  finalTexto += '</ul>';
  resultadosDiv.innerHTML = finalTexto;
});

// Botón para limpiar todo y reiniciar el análisis
limpiarBtn.addEventListener('click', function () {
  window.location.reload();
});
</script>
</body>
</html>